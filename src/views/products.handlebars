<div class="page-header">
    <h2>üõçÔ∏è Cat√°logo de Productos</h2>
    <p>Explora nuestra selecci√≥n de productos</p>
</div>


<div class="filters-container">
    <form class="filters-form" method="GET" action="/products">
        <div class="filter-group">
            <label for="query">Categor√≠a:</label>
            <select name="query" id="query">
                <option value="">Todas</option>
                <option value="available" {{#if (eq query 'available')}}selected{{/if}}>Disponibles</option>
                <option value="Electr√≥nica" {{#if (eq query 'Electr√≥nica')}}selected{{/if}}>Electr√≥nica</option>
                <option value="Ropa" {{#if (eq query 'Ropa')}}selected{{/if}}>Ropa</option>
                <option value="Hogar" {{#if (eq query 'Hogar')}}selected{{/if}}>Hogar</option>
                <option value="Deportes" {{#if (eq query 'Deportes')}}selected{{/if}}>Deportes</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="sort">Ordenar por precio:</label>
            <select name="sort" id="sort">
                <option value="">Sin orden</option>
                <option value="asc" {{#if (eq sort 'asc')}}selected{{/if}}>Menor a Mayor</option>
                <option value="desc" {{#if (eq sort 'desc')}}selected{{/if}}>Mayor a Menor</option>
            </select>
        </div>

        <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
    </form>
</div>

{{#if error}}
    <div class="alert alert-error">
        <p>{{error}}</p>
    </div>
{{/if}}

{{#if products.length}}

    <div class="products-grid">
        {{#each products}}
            <div class="product-card">
                <div class="product-header">
                    <h3>{{this.title}}</h3>
                    <span class="product-price">${{this.price}}</span>
                </div>
                
                <p class="product-description">{{this.description}}</p>
                
                <div class="product-info">
                    <span class="badge {{#if this.status}}badge-success{{else}}badge-error{{/if}}">
                        {{#if this.status}}Disponible{{else}}Agotado{{/if}}
                    </span>
                    <span class="product-stock">Stock: {{this.stock}}</span>
                </div>
                
                <p class="product-category">
                    <strong>Categor√≠a:</strong> {{this.category}}
                </p>
                
                <div class="product-actions">
                    <a href="/products/{{this._id}}" class="btn btn-secondary">Ver Detalles</a>
                    <button class="btn btn-primary" onclick="addToCart('{{this._id}}')">
                        üõí Agregar al Carrito
                    </button>
                </div>
            </div>
        {{/each}}
    </div>


    <div class="pagination">
        <div class="pagination-info">
            <p>P√°gina {{page}} de {{totalPages}}</p>
        </div>
        
        <div class="pagination-controls">
            {{#if hasPrevPage}}
                <a href="{{prevLink}}" class="btn btn-secondary">‚Üê Anterior</a>
            {{else}}
                <button class="btn btn-secondary" disabled>‚Üê Anterior</button>
            {{/if}}
            
            <span class="page-number">{{page}}</span>
            
            {{#if hasNextPage}}
                <a href="{{nextLink}}" class="btn btn-secondary">Siguiente ‚Üí</a>
            {{else}}
                <button class="btn btn-secondary" disabled>Siguiente ‚Üí</button>
            {{/if}}
        </div>
    </div>
{{else}}
    <div class="alert alert-info">
        <p>No hay productos disponibles con los filtros seleccionados.</p>
    </div>
{{/if}}

<script>

async function addToCart(productId) {
    try {
        
        let cartId = localStorage.getItem('cartId');
        
        if (!cartId) {
            
            const response = await fetch('/api/carts', {
                method: 'POST'
            });
            const data = await response.json();
            cartId = data.payload._id;
            localStorage.setItem('cartId', cartId);
        }
        
        
        const response = await fetch(`/api/carts/${cartId}/product/${productId}`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            showNotification('Producto agregado al carrito', 'success');
        } else {
            showNotification(data.message || 'Error al agregar producto', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error al agregar producto al carrito', 'error');
    }
}


function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 2rem;
        border-radius: 8px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
        ${type === 'success' ? 'background: #10b981;' : 'background: #ef4444;'}
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}

const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);
</script>